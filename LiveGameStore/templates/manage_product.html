{% extends 'base_a.html' %}
{% load static %}
{% block start %}
{% include 'navbar.html' %}
<!-- Bootstrap 5 CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
  /* Your existing CSS styles (no changes needed) */
  body {
    background-color: #000000;
    font-family: 'Segoe UI', sans-serif;
  }
  .container-custom {
    margin-top: 60px;
    max-width: 1200px;
    padding: 30px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }
  .table thead th {
    vertical-align: middle;
    border-bottom: none;
  }
  .table td {
    border-top: none;
  }
  .badge-yes {
    background-color: #28a745;
  }
  .badge-no {
    background-color: #dc3545;
  }
  .btn-add {
    background-color: #007bff;
    color: white;
    font-weight: bold;
    border-radius: 6px;
  }
  .search-input {
    max-width: 250px;
  }
  .table-hover tbody tr:hover {
    background-color: #f1f5f9;
  }
  .table-highlight {
    border-left: 4px solid #007bff;
    background-color: #f0f8ff;
  }
  .section-title {
    font-weight: 600;
    font-size: 1.6rem;
  }
  .search-box input {
    border-radius: 6px;
  }
  .product-img {
    width: auto;
    height: 100px;
  }
  .custom-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 40px auto;
    padding: 15px 30px;
    background-color: #fceeee;
    border-radius: 40px;
    box-shadow: 0 5px 15px rgba(255, 0, 0, 0.15);
    flex-wrap: wrap;
    gap: 10px;
  }
  .pagination-page,
  .pagination-arrow {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    background-color: white;
    color: red;
    border-radius: 50%;
    text-decoration: none;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(255, 0, 0, 0.15);
    border: none;
    cursor: pointer;
  }
  .pagination-page.active {
    background-color: red;
    color: white;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
  }
  .pagination-page:hover,
  .pagination-arrow:hover {
    background-color: red;
    color: white;
  }
  .pagination-dots {
    color: red;
    font-weight: bold;
    padding: 0 6px;
  }
</style>

<div class="container container-custom">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="section-title">
      Total Product: <span class="text-muted">({{ pageFinal.paginator.count }})</span>
      <a href="{% url 'add_product' %}" class="btn btn-primary btn-add">Add New Product</a>
    </div>
    <form id="search-form" method="GET" class="mb-4" onsubmit="handleSearch(event)">
      <div class="input-group">
        <input type="text" name="q" class="form-control" placeholder="Search by name or category..." value="{{ request.GET.q|default:'' }}">
        <button type="submit" class="btn btn-dark">Search</button>
        <button type="button" class="btn btn-secondary" onclick="clearSearch()">Clear</button>
      </div>
    </form>
  </div>

  <table class="table table-hover rounded">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Preview</th>
        <th>Description</th>
        <th>Price</th>
        <th>Stock</th>
        <th>Category</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="product-rows">
      {% include 'product_rows.html' with products=products %}
    </tbody>
  </table>

  <div id="pagination-container">
    {% include 'pagination.html' with pageFinal=pageFinal q=request.GET.q %}
  </div>
</div>

<script>
  // Handle form submit with AJAX
  function handleSearch(event) {
    event.preventDefault();
    fetchPage(1);  // Always start from page 1 on new search
  }

  // Unified function to fetch data for given page + query
  function fetchPage(page) {
    const input = document.querySelector('input[name="q"]');
    const q = input.value.trim();
    const params = new URLSearchParams();
    if (q) params.append('q', q);
    if (page) params.append('page', page);

    fetch(`?${params.toString()}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById('product-rows').innerHTML = data.rows_html;
      document.getElementById('pagination-container').innerHTML = data.pagination_html;
      attachPaginationHandlers();  // rebind pagination links
    })
    .catch(console.error);
  }

  // Attach AJAX handlers to pagination links
  function attachPaginationHandlers() {
    const links = document.querySelectorAll('#pagination-container a.pagination-page, #pagination-container a.pagination-arrow');
    links.forEach(link => {
      link.onclick = function(event) {
        event.preventDefault();
        const urlParams = new URLSearchParams(this.search);
        const page = urlParams.get('page') || 1;
        fetchPage(page);
      };
    });
  }

  // Clear search box and reload first page
  function clearSearch() {
    const input = document.querySelector('input[name="q"]');
    input.value = '';
    fetchPage(1);
  }

  // Initial setup on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    attachPaginationHandlers();
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
