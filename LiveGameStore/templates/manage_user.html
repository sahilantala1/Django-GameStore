{% extends 'base_a.html' %}
{% load static %}
{% block start %}

{% include 'navbar.html' %}

<!-- Bootstrap & Font Awesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  .table-title {
    padding: 15px;
    background: #343a40;
    color: #fff;
    border-radius: 0.25rem 0.25rem 0 0;
  }

  .status-badge {
    font-size: 0.875em;
    padding: 0.3em 0.6em;
    border-radius: 0.25rem;
  }

  .status-active { background: #28a745; color: #fff; }
  .status-inactive { background: #6c757d; color: #fff; }
  .status-banned { background: #dc3545; color: #fff; }
  .status-pending { background: #0d6efd; color: #fff; }
  .status-suspended { background: #fd7e14; color: #fff; }

  .avatar {
    width: 32px;
    height: 32px;
    object-fit: cover;
    border-radius: 50%;
    margin-right: 0.5rem;
  }

  .user-icon {
    font-size: 22px;
    margin: 0 5px;
  }
</style>

<script>
  const csrfToken = '{{ csrf_token }}';
</script>

<div class="container my-4">
  <!-- Table Title -->
  <div class="table-title d-flex justify-content-between align-items-center">
    <h4 class="mb-0">User Management</h4>
  </div>

  <!-- Search Form -->
  <form id="searchForm" class="row my-3" method="get" action="">
    <div class="col-md-3">
      <input
        type="text"
        name="q"
        id="searchInput"
        value="{{ query|default:'' }}"
        class="form-control"
        placeholder="Search username or email..."
      />
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary">
        <i class="fa fa-search"></i> Search
      </button>
    </div>
  </form>

  <!-- User Table -->
  <div id="userTableContainer" class="table-responsive">
    <table class="table table-striped align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>No</th>
          <th>Username</th>
          <th>Email</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
        {% for user in users %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ user.username|default:"-" }}</td>
          <td>{{ user.email|default:"-" }}</td>
          <td>
            <a class="user-icon text-success" href="{% url 'user_edit' user.id %}">
              <i class="fa-solid fa-gear"></i>
            </a>
            <a class="user-icon text-danger" href="javascript:void(0);" onclick="confirmDelete({{ user.id }})">
              <i class="fa-solid fa-trash"></i>
            </a>
            <a class="user-icon text-primary" href="#">
              <i class="fa-solid fa-eye"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    document.getElementById('searchForm').addEventListener('submit', function (e) {
      e.preventDefault(); // Prevent full page reload

      const query = document.getElementById('searchInput').value;

      fetch(`/manage_user/ajax_search/?q=${encodeURIComponent(query)}`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.text())
      .then(html => {
        document.getElementById('userTableBody').innerHTML = html;
      })
      .catch(error => {
        console.error('Error during AJAX request:', error);
      });
    });

    function confirmDelete(userId) {
      Swal.fire({
        title: 'Are you sure?',
        text: "This user will be deleted permanently!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/manage_user/delete/${userId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            if (response.ok) {
              Swal.fire({
                title: 'Deleted!',
                text: "User has been deleted.",
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
              }).then(() => {
                location.reload();
              });
            } else {
              Swal.fire("Error", "Failed to delete the user.", "error");
            }
          });
        }
      });
    }

    // SweetAlert for Django messages
    document.addEventListener("DOMContentLoaded", function () {
      {% if messages %}
        {% for message in messages %}
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: '{{ message|escapejs }}',
            timer: 2000,
            showConfirmButton: false
          });
        {% endfor %}
      {% endif %}
    });
</script>

{% endblock %}
